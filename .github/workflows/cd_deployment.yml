name: deploy to production

on:
  push:
    branches: [main]

jobs:
  redeploy_monorepo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Setup SSH key for deploy user
        run: |
          echo "${{ secrets.PROD_SECRET}}" > ~/ssh_key
          chmod 600 ~/ssh_key

      - name: SSH into server and deploy
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/ssh_key deploy@93.127.185.146 << 'EOF'
            set -e

            # Load environment
            source ~/.bashrc
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm use 22.21.1

            export PATH="$PNPM_HOME:$PATH"

            cd /home/deploy/app

            echo "Pulling latest changes..."
            git fetch origin main
            CHANGED_FILES=$(git diff --name-only HEAD..origin/main)
            git pull

            echo "Installing dependencies..."
            pnpm install --frozen-lockfile

            if echo "$CHANGED_FILES" | grep -q '^packages/db/'; then
              echo "Building packages/db"
              cd packages/db && pnpm build && pnpm prisma generate && cd -
            fi

            if echo "$CHANGED_FILES" | grep -q '^packages/config-types/'; then
              echo "Building packages/config-types"
              cd packages/config-types && pnpm build && cd -
            fi

            if echo "$CHANGED_FILES" | grep -q '^apps/server/'; then
              echo "Restarting server"
              cd apps/server && pnpm build && cd -
              pm2 restart server || pm2 start ecosystem.config.js --only server
            fi

            if echo "$CHANGED_FILES" | grep -q '^apps/web/'; then
              echo "Restarting web"
              cd apps/web && pnpm build && cd -
              pm2 restart web || pm2 start ecosystem.config.js --only web
            fi

            if echo "$CHANGED_FILES" | grep -q '^apps/landing/'; then
              echo "Restarting landing"
              cd apps/landing && pnpm build && cd -
              pm2 restart landing || pm2 start ecosystem.config.js --only landing
            fi

            pm2 save
            echo "Deployment Completed"
          EOF
