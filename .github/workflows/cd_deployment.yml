name: deploy to production

on:
  push:
    branches: [main]

jobs:
  redeploy_monorepo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          set -e
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_SECRET }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 93.127.185.146 >> ~/.ssh/known_hosts

      - name: SSH into server and deploy
        run: |
          set -e
          ssh \
            -o ServerAliveInterval=60 \
            -o ServerAliveCountMax=5 \
            -i ~/.ssh/id_rsa \
            deploy@93.127.185.146 << 'EOF'
            set -euo pipefail

            # Load environment
            source ~/.bashrc
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            nvm use 22.22.0

            export PNPM_HOME="/home/deploy/.local/share/pnpm"
            export PATH="$PNPM_HOME:$PATH"

            cd /home/deploy/app || exit 1

            echo "Pulling latest changes..."
            git fetch origin main

            BEFORE_COMMIT=$(git rev-parse HEAD)
            git pull origin main
            CHANGED_FILES=$(git diff --name-only "$BEFORE_COMMIT"..HEAD)

            echo "Changed files:"
            echo "$CHANGED_FILES"

            echo "Installing dependencies..."
            pnpm install

            if echo "$CHANGED_FILES" | grep -q '^packages/db/'; then
              echo "Building packages/db"
              cd packages/db && pnpm build && pnpm prisma generate && cd -
            fi

            if echo "$CHANGED_FILES" | grep -q '^packages/config-types/'; then
              echo "Building packages/config-types"
              cd packages/config-types && pnpm build && cd -
            fi

            if echo "$CHANGED_FILES" | grep -q '^apps/server/'; then
              echo "Restarting server"
              cd apps/server && pnpm build && cd -
              pm2 restart server || pm2 start ecosystem.config.js --only server
            fi

            if echo "$CHANGED_FILES" | grep -q '^apps/web/'; then
              echo "Restarting web"
              cd apps/web && pnpm build && cd -
              pm2 restart web || pm2 start ecosystem.config.js --only web
            fi

            if echo "$CHANGED_FILES" | grep -q '^apps/landing/'; then
              echo "Restarting landing"
              cd apps/landing && pnpm build && cd -
              pm2 restart landing || pm2 start ecosystem.config.js --only landing
            fi

            pm2 save
            echo "Deployment Completed"
          EOF
